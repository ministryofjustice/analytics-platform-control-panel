version: "3"
services:
  db:
    image: "postgres:13.3"
    environment:
      POSTGRES_DB: "controlpanel"
      POSTGRES_PASSWORD: "password"
      POSTGRES_USER: "controlpanel"
      REGION: $REGION
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
  redis:
    image: "redis"
    environment:
      REDIS_PASSWORD: "controlpanel"
    command: sh -c "exec redis-server --requirepass \"$${REDIS_PASSWORD}\""

  migration:
    build:
      context: .
      network: ${NETWORK:-default}
      dockerfile: Dockerfile_EKS
    depends_on:
      db:
        condition: service_healthy
    environment:
      AWS_CLUSTER_PROFILE: ${AWS_CLUSTER_PROFILE}
      AWS_DATA_PROFILE: ${AWS_DATA_PROFILE}
      AWS_DEFAULT_REGION:
      AWS_DATA_ROLE: ${AWS_DATA_ROLE}
      AWS_DEV_ROLE: ${AWS_DEV_ROLE}
      AWS_REGION: ${AWS_REGION:-eu-west-1}
      AWS_MFA_SERIAL: ${LANDING_AWS_MFA_SERIAL}
      AWS_PROFILE: ${AWS_DATA_PROFILE}
      DB_HOST: "db"
      DB_NAME: "controlpanel"
      DB_PASSWORD: "password"
      DB_PORT: 5432
      DB_USER: "controlpanel"
      DEBUG: "True"
      defaultRegion: eu-west-1
      DJANGO_SETTINGS_MODULE: ${DJANGO_SETTINGS_MODULE}
      EFS_VOLUME: ${EFS_VOLUME}
      EKS: "True"
      ENV: "dev"
      EKS_CLUSTER: ${DEV_CLUSTER}
      iamRole: ${iamRole:-dev_control_panel_api}
      LANDING_AWS_ACCESS_KEY_ID: ${LANDING_AWS_ACCESS_KEY_ID}
      LANDING_AWS_SECRET_ACCESS_KEY: ${LANDING_AWS_SECRET_ACCESS_KEY}
      OIDC_EKS_PROVIDER: ${OIDC_EKS_PROVIDER}
      PYTHONUNBUFFERED: "1"
      SLACK_API_TOKEN: "dummy"
      SLACK_CHANNEL: ${SLACK_CHANNEL}
    command: sh -c "./manage.py migrate"

  worker:
    build:
      context: .
      network: ${NETWORK:-default}
      dockerfile: Dockerfile_EKS
    depends_on:
      redis:
        condition: service_started
      db:
        condition: service_healthy
    command: ["python3", "manage.py", "runworker", "background_tasks"]
    environment:
      AWS_CLUSTER_PROFILE: ${AWS_CLUSTER_PROFILE}
      AWS_DATA_PROFILE: ${AWS_DATA_PROFILE}
      AWS_DEFAULT_REGION:
      AWS_DATA_ROLE: ${AWS_DATA_ROLE}
      AWS_DEV_ROLE: ${AWS_DEV_ROLE}
      AWS_REGION: ${AWS_REGION:-eu-west-1}
      AWS_MFA_SERIAL: ${LANDING_AWS_MFA_SERIAL}
      AWS_PROFILE: ${AWS_DATA_PROFILE}
      DB_HOST: "db"
      DB_NAME: controlpanel
      DB_PASSWORD: password
      DB_PORT: 5432
      DB_USER: controlpanel
      defaultRegion: eu-west-1
      DJANGO_SETTINGS_MODULE: ${DJANGO_SETTINGS_MODULE}
      EFS_VOLUME: ${EFS_VOLUME}
      EKS: "True"
      ENV: "dev"
      EKS_CLUSTER: ${DEV_CLUSTER}
      iamRole: ${iamRole:-dev_control_panel_api}
      LANDING_AWS_ACCESS_KEY_ID: ${LANDING_AWS_ACCESS_KEY_ID}
      LANDING_AWS_SECRET_ACCESS_KEY: ${LANDING_AWS_SECRET_ACCESS_KEY}
      OIDC_AUTH_EXTENSION_URL: ${OIDC_AUTH_EXTENSION_URL}
      OIDC_CLIENT_ID: ${OIDC_CLIENT_ID}
      OIDC_CLIENT_SECRET: ${OIDC_CLIENT_SECRET}
      OIDC_EKS_PROVIDER: ${OIDC_EKS_PROVIDER}
      OIDC_DOMAIN: dev-analytics-moj.eu.auth0.com
      OIDC_OP_AUTHORIZATION_ENDPOINT: ${OIDC_OP_AUTHORIZATION_ENDPOINT}
      OIDC_OP_JWKS_ENDPOINT: ${OIDC_OP_JWKS_ENDPOINT}
      OIDC_OP_TOKEN_ENDPOINT: ${OIDC_OP_TOKEN_ENDPOINT}
      OIDC_OP_USER_ENDPOINT: ${OIDC_OP_USER_ENDPOINT}
      OIDC_RP_SIGN_ALGO: "RS256"
      PYTHONUNBUFFERED: "1"
      REDIS_HOST: "redis"
      REDIS_PASSWORD: "controlpanel"
      SECRET_KEY: "1234567890"
      SLACK_API_TOKEN: "dummy"
      SLACK_CHANNEL: ${SLACK_CHANNEL}
      TOOLS_DOMAIN: ${TOOLS_DOMAIN:-tools.dev.analytical-platform.service.justice.gov.uk}

  frontend:
    image: ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG:-latest}
    build:
      dockerfile: Dockerfile_EKS
      context: .
    ports: ["8000:8000"]
    depends_on:
      worker:
        condition: service_started
      db:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      AIRFLOW_AUTH_CLIENT_DOMAIN: ${AIRFLOW_AUTH_CLIENT_DOMAIN}
      AIRFLOW_AUTH_CLIENT_ID: ${AIRFLOW_AUTH_CLIENT_ID}
      AIRFLOW_AUTH_CLIENT_SECRET: ${AIRFLOW_AUTH_CLIENT_SECRET}
      AIRFLOW_FERNET_KEY: ${AIRFLOW_FERNET_KEY}
      AIRFLOW_SECRET_KEY: ${AIRFLOW_SECRET_KEY}
      ALLOWED_HOSTS: "localhost 127.0.0.1 0.0.0.0"
      AWS_CLUSTER_PROFILE: ${AWS_CLUSTER_PROFILE}
      AWS_DATA_PROFILE: ${AWS_DATA_PROFILE}
      AWS_DEFAULT_REGION:
      AWS_DATA_ROLE: ${AWS_DATA_ROLE}
      AWS_DEV_ROLE: ${AWS_DEV_ROLE}
      AWS_REGION: ${AWS_REGION:-eu-west-1}
      AWS_MFA_SERIAL: ${LANDING_AWS_MFA_SERIAL}
      AWS_PROFILE: ${AWS_DATA_PROFILE}
      DB_HOST: "db"
      DB_NAME: controlpanel
      DB_PASSWORD: password
      DB_PORT: 5432
      DB_USER: controlpanel
      DEBUG: "True"
      DJANGO_SETTINGS_MODULE: ${DJANGO_SETTINGS_MODULE}
      EFS_VOLUME: ${EFS_VOLUME}
      EKS: "True"
      EKS_CLUSTER: ${DEV_CLUSTER}
      ELASTICSEARCH_HOST: ${ELASTICSEARCH_HOST}
      ELASTICSEARCH_PASSWORD: ${ELASTICSEARCH_PASSWORD}
      ELASTICSEARCH_USERNAME: ${ELASTICSEARCH_USERNAME}
      ENV: "dev"
      IAM_ARN_BASE: ${IAM_ARN_BASE}
      JUPYTER_LAB_AUTH_CLIENT_DOMAIN: ${JUPYTER_LAB_AUTH_CLIENT_DOMAIN}
      JUPYTER_LAB_AUTH_CLIENT_ID: ${JUPYTER_LAB_AUTH_CLIENT_ID}
      JUPYTER_LAB_AUTH_CLIENT_SECRET: ${JUPYTER_LAB_AUTH_CLIENT_SECRET}
      K8S_WORKER_ROLE_NAME: ${K8S_WORKER_ROLE_NAME}
      LANDING_AWS_ACCESS_KEY_ID: ${LANDING_AWS_ACCESS_KEY_ID}
      LANDING_AWS_SECRET_ACCESS_KEY: ${LANDING_AWS_SECRET_ACCESS_KEY}
      LOGS_BUCKET_NAME: ${LOGS_BUCKET_NAME}
      NFS_HOSTNAME: ${NFS_HOSTNAME}
      OIDC_AUTH_EXTENSION_URL: ${OIDC_AUTH_EXTENSION_URL}
      OIDC_CLIENT_ID: ${OIDC_CLIENT_ID}
      OIDC_CLIENT_SECRET: ${OIDC_CLIENT_SECRET}
      OIDC_DOMAIN: dev-analytics-moj.eu.auth0.com
      OIDC_OP_AUTHORIZATION_ENDPOINT: ${OIDC_OP_AUTHORIZATION_ENDPOINT}
      OIDC_OP_JWKS_ENDPOINT: ${OIDC_OP_JWKS_ENDPOINT}
      OIDC_OP_TOKEN_ENDPOINT: ${OIDC_OP_TOKEN_ENDPOINT}
      OIDC_OP_USER_ENDPOINT: ${OIDC_OP_USER_ENDPOINT}
      OIDC_RP_SIGN_ALGO: "RS256"
      PYTHONUNBUFFERED: "1"
      REDIS_HOST: "redis"
      REDIS_PASSWORD: "controlpanel"
      RSTUDIO_AUTH_CLIENT_DOMAIN: ${RSTUDIO_AUTH_CLIENT_DOMAIN}
      RSTUDIO_AUTH_CLIENT_ID: ${RSTUDIO_AUTH_CLIENT_ID}
      RSTUDIO_AUTH_CLIENT_SECRET: ${RSTUDIO_AUTH_CLIENT_SECRET}
      SAML_PROVIDER: ${SAML_PROVIDER}
      OIDC_EKS_PROVIDER: ${OIDC_EKS_PROVIDER}
      SECRET_KEY: "1234567890"
      SLACK_API_TOKEN: "dummy"
      SLACK_CHANNEL: ${SLACK_CHANNEL}
      TOOLS_DOMAIN: ${TOOLS_DOMAIN:-tools.dev.analytical-platform.service.justice.gov.uk}
      defaultRegion: eu-west-1
      iamRole: ${iamRole:-dev_control_panel_api}
