version: "3"
services:
  db:
    image: "postgres:9.6"
    network_mode: ${NETWORK:-default}
    environment:
      POSTGRES_DB: "controlpanel"
      POSTGRES_USER: "controlpanel"
      POSTGRES_PASSWORD: "password"

  redis:
    image: "redis"
    network_mode: ${NETWORK:-default}
    environment:
      REDIS_PASSWORD: "controlpanel"
    command: sh -c "exec redis-server --requirepass \"$${REDIS_PASSWORD}\""

  migration:
    image: ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG:-latest}
    network_mode: ${NETWORK:-default}
    depends_on: [db]
    links: [db]
    environment:
      DB_HOST: "db"
      DB_NAME: "controlpanel"
      DB_USER: "controlpanel"
      DB_PASSWORD: "password"
      DB_PORT: 5432
      DEBUG: "True"
      PYTHONUNBUFFERED: "1"
      SLACK_API_TOKEN: "dummy"
    command: sh -c "until pg_isready -h db; do sleep 2; done; ./manage.py migrate"

  worker:
    image: ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG:-latest}
    network_mode: ${NETWORK:-default}
    depends_on: [redis, db]
    links: [redis, db]
    volumes:
      - ~/.kube/controlpanel:/home/controlpanel/.kube/config:ro
    command: ["python3", "manage.py", "runworker", "background_tasks"]
    environment:
      DB_HOST: "db"
      DB_PORT: 5432
      PYTHONUNBUFFERED: "1"
      REDIS_HOST: "redis"
      REDIS_PASSWORD: "controlpanel"
      DJANGO_SETTINGS_MODULE: controlpanel.settings.test
      DB_NAME: controlpanel
      DB_USER: controlpanel
      DB_PASSWORD: password
      ENV: "dev"
      SECRET_KEY: "${SECRET_KEY:-1234567890}"
      OIDC_DOMAIN: dev-analytics-moj.eu.auth0.com
      SLACK_API_TOKEN: "dummy"
      defaultRegion: eu-west-1
      iamRole: ${iamRole:-dev_control_panel_api}

  frontend:
    image: ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG:-latest}
    build:
      context: .
      network: ${NETWORK:-default}
    network_mode: ${NETWORK:-default}
    ports: ["8000:8000"]
    depends_on: [worker, db]
    links: [worker, db]
    volumes:
      - ~/.kube/controlpanel:/home/controlpanel/.kube/config:ro
      - ~/.aws/credentials:/home/controlpanel/.aws/credentials:ro
    command: ["python3", "manage.py", "runserver", "0.0.0.0:8000"]
    environment:
      ALLOWED_HOSTS: "localhost 127.0.0.1 0.0.0.0"
      DB_HOST: "db"
      DB_PORT: 5432
      DEBUG: "True"
      PYTHONUNBUFFERED: "1"
      REDIS_HOST: "redis"
      REDIS_PASSWORD: "controlpanel"
      AWS_REGION: ${AWS_REGION:-eu-west-1}
      DJANGO_SETTINGS_MODULE: "controlpanel.settings.test"
      DB_NAME: controlpanel
      DB_USER: controlpanel
      DB_PASSWORD: password
      ENV: "dev"
      SECRET_KEY: "${SECRET_KEY:-1234567890}"
      SLACK_API_TOKEN: "dummy"
      defaultRegion: eu-west-1
      iamRole: ${iamRole:-dev_control_panel_api}
