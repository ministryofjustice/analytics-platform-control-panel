{% from "checkboxes/macro.html" import govukCheckboxes %}
{% from "fieldset/macro.html" import govukFieldset %}
{% from "user/macro.html" import user_name %}
{% from "includes/app-list.html" import app_list with context %}
{% from "includes/datasource-list.html" import datasource_list with context %}

{% extends "base.html" %}

{% set page_title = user_name(object) %}
{% set pronoun = "Your" if object == request.user else "User's" %}

{% block content %}
<span class="govuk-caption-xl">User</span>
<h1 class="govuk-heading-xl">{{ page_title }}</h1>

{% if request.user.is_superuser %}
<section class="cpanel-section">
  <form action="{{ url('set-superadmin', kwargs={ "pk": object.auth0_id }) }}" method="post">
    {{ csrf_input }}
    {{ govukCheckboxes({
      "name": "is_superuser",
      "fieldset": {
        "legend": {
          "text": "Super Admin",
          "classes": "govuk-fieldset__legend--m",
        },
      },
      "hint": {
        "text": "User is a super admin, allowing all privileges on the Control panel."
      },
      "items": [
        {
          "value": "True",
          "text": "Super Admin",
          "checked": object.is_superuser
        },
      ]
    }) }}
    <button class="govuk-button hmcts-button--secondary">
      Save changes
    </button>
  </form>
</section>
{% endif %}

{% if request.user.is_superuser %}
<section class="cpanel-section">
  <form action="{{ url('reset-mfa', kwargs={ "pk": object.auth0_id }) }}" method="post">
    {{ csrf_input }}
    {% call govukFieldset({
      "legend": {
        "text": "Reset MFA",
        "classes": "govuk-fieldset__legend--m",
      },
      "describedBy": "reset-hint"
    }) %}
      <span id="reset-hint" class="govuk-hint">
        Reset the user's multi-factor authentication settings, forcing them to
        reconfigure.
      </span>
      <button class="govuk-button hmcts-button--secondary">Reset MFA</button>
    {%- endcall %}
  </form>
</section>
{% endif %}

<section class="cpanel-section">
  <h2 class="govuk-heading-m">{{ pronoun }} apps</h2>
  {{ app_list(object.userapps.all()|map(attribute="app")|list, object) }}
</section>

{# user's datasources #}
<section class="cpanel-section">
  <h2 class="govuk-heading-m">{{ pronoun }} webapp data sources</h2>
  {{
  datasource_list(object.users3buckets.filter(s3bucket__is_data_warehouse=False)|map(attribute="s3bucket")|list, "webapp", object) }}
</section>

{% if request.user.is_superuser %}
<section class="cpanel-section">
  <form action="{{ url("delete-user", kwargs={ "pk": object.auth0_id }) }}" method="post">
    {{ csrf_input }}
    <button class="govuk-button cpanel-button--destructive confirm"
            data-confirmation-prompt="Are you sure you want to delete this user?">
      Delete user
    </button>
  </form>
</section>
{% endif %}

{% endblock %}
