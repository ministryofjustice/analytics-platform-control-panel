{% extends "base.html" %}
{% from "autocomplete/macro.html" import autocomplete %}
{% from "error-message/macro.html" import govukErrorMessage %}
{% from "label/macro.html" import govukLabel %}
{% from "modal-dialog/macro.html" import modal_dialog %}
{% from "tag/macro.html" import tag %}
{% from "selectable-rows/macro.html" import row_selector %}
{% from "user/macro.html" import user_name %}
{% from "app-logs/macro.html" import app_logs with context %}
{% from "includes/yesno.html" import yes_no %}

{% set page_name = "webapps" %}
{% set page_title = app.name %}

{% set app_admins_html %}
{% include "modals/app_admins.html" %}
{% endset %}

{% set app_access_levels_html %}
{% include "modals/app_data_access_levels.html" %}
{% endset %}

{% block content %}
<header>
  <span class="govuk-caption-xl">Webapp</span>
  <h1 class="govuk-heading-xl">{{ page_title }}</h1>

  {% if feature_enabled and app.description %}
  <p class="govuk-body">
    {{ app.description }}
  </p>
  {% endif %}

  {% if feature_enabled and repo_access_error_msg %}
  <div class="govuk-grid-row">
    <div class="govuk-column-two-thirds">

      <div class="govuk-error-summary" role="alert" aria-labelledby="error-summary-heading-example-1" tabindex="-1">
        <h2 class="govuk-heading-m govuk-error-summary-heading">
        Webapp repo setting
        </h2>
        <p>
          <strong>Couldn't find/read the app's information from github repo based on the repo url, please
            check whether the repo_url exists or whether you have enough permission to access this repo
          </strong>
        </p>
        <p>Raw error message: {{ repo_access_error_msg }}</p>
      </div>
    </div>
  </div>
  {% endif %}

  {% if app_url %}
  <h2 class="govuk-heading-m">Deployed URL</h2>
      <p> If the app is successfully built, it will be deployed here:</p>
  <p class="govuk-body">
      <a href="{{ app_url }}">{{ app_url }}</a>
  </p>
  {% endif %}

  <h2 class="govuk-heading-m">Source Code Repository</h2>
  <p class="govuk-body">
    {% if app.repo_url %}
      <a href="{{ app.repo_url }}">{{ app.repo_url }}</a>
    {% else %}
      None
    {% endif %}
  </p>

  <h2 class="govuk-heading-m">Deployment Pipeline</h2>
  <p class="govuk-body">
    <a href="https://concourse.services.{{env}}.mojanalytics.xyz/teams/main/pipelines/{{ app.name }}">
    https://concourse.services.{{env}}.mojanalytics.xyz/teams/main/pipelines/{{ app.name }}
    </a>
  </p>
</header>

<section class="cpanel-section">
  {% if feature_enabled %}
    <p><strong>You are required to be member of admin team for this app repo in order to be able to maintain the settings</strong></p>

    {% if github_settings_access_error_msg %}
      <div class="govuk-error-summary" role="alert" aria-labelledby="error-summary-heading-example-1" tabindex="-1">
        <p style="color:red">Couldn't load the github settings</p>
        <p style="color:red">Raw error message: {{ github_settings_access_error_msg }}</p>
      </div>
    {% endif %}

    {% for env_name, deployment_setting in deployments_settings.items() %}
      <h2 class="govuk-heading-m" >Deployment settings under {{ env_name }}</h2>
      <p>The settings required for deploying the app into the cluster</p>
      <hr style="height:5px;border:none;color:#333;background-color:#333;"/>
      <section>
        <h3 class="govuk-heading-s">App Secrets</h3>
        <p>the settings on this category are all sensitive, the actual value won't be revealed except IP_RANGES.</p>
        <table class="govuk-table app-data-sources form-group">
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th class="govuk-table__header">Key</th>
              <th class="govuk-table__header">Values</th>
              <th class="govuk-table__header"></th>
              <th class="govuk-table__header"></th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for app_secret in deployment_setting["secrets"] %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">{{ app_secret["name"] }}</td>
              <td class="govuk-table__cell">{{ app_secret["value"] }} {% if app_secret["value"] == None %}<b style="color:red">[Missing] {% endif %}</b></td>
              <td class="govuk-table__cell">
                {% if request.user.has_perm(app_secret["permission_flg"], app) and app_secret["editable"] %}
                  {% if "app-secret" not in app_secret['edit_link'] %}
                    <a href="{{ url(app_secret['edit_link'], kwargs={'pk': app.id }) }}?env_name={{ env_name }}" class="govuk-button govuk-button--secondary right">Edit</a>
                  {% else %}
                    <a href="{{ url(app_secret['edit_link'], kwargs={'pk': app.id, 'secret_name': app_secret['name']}) }}?env_name={{ env_name }}" class="govuk-button govuk-button--secondary right">Edit</a>
                  {% endif %}
                {% endif %}
              </td>
              <td class="govuk-table__cell">
                {% if request.user.has_perm(app_secret["permission_flg"], app) and app_secret["removable"] %}
                  <form action="{{ url(app_secret['remove_link'], kwargs={'pk': app.id, 'secret_name': app_secret['name']}) }}" method="post">
                    {{ csrf_input }}
                    <input type="hidden" name="env_name" value="{{ env_name }}">
                    <button class="govuk-button cpanel-button--destructive js-confirm"
                          data-confirm-message="Are you sure you want to delete this secret?">
                      Delete
                    </button>
                  </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
            <tr class="govuk-table__row">
              <td><a href="{{ url('create-app-secret', kwargs={'pk': app.id} ) }}?env_name={{ env_name }}" class="govuk-button" >Add new Secret</a></td>
            </tr>
          </tbody>
        </table>
      </section>

      {% if request.user.has_perm('api.update_app', app) and deployment_setting['can_create_client'] %}
        <section class="cpanel-section">
          <p style="color:red">As the authentication flag is on,
            the auth0-client needs to be created and related settings need to be stored in github</p>
          <form action="{{ url('create-auth0-client', kwargs={ 'pk': app.id }) }}" method="post">
            {{ csrf_input }}
            <input type="hidden" name="env_name" value="{{ env_name }}">
            <button class="govuk-button cpanel-button--destructive js-confirm"
                    data-confirm-message="Are you sure you want to create auth0 a client for this app?">
              Create auth0 client
            </button>
          </form>
        </section>
      {% endif %}

      {% if request.user.has_perm('api.update_app', app) and deployment_setting['can_remove_client'] %}
        <section class="cpanel-section">
          <p style="color:red">As the authentication flag is off, the auth0-client and related settings in github can be removed</p>
          <form action="{{ url('remove-auth0-client', kwargs={'pk': app.id }) }}" method="post">
            {{ csrf_input }}
            <input type="hidden" name="env_name" value="{{ env_name }}">
            <button class="govuk-button cpanel-button--destructive js-confirm"
                    data-confirm-message="Are you sure you want to delete the auth0 client for this app?">
              Remove auth0 client
            </button>
          </form>
        </section>
      {% endif %}

      <section>
        <h3 class="govuk-heading-s" >App environment variables</h3>
        <p>The settings on this category are not sensitive data.</p>

        <table class="govuk-table app-data-sources form-group">
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th class="govuk-table__header">Name</th>
              <th class="govuk-table__header">Value</th>
              <th class="govuk-table__header"></th>
              <th class="govuk-table__header"></th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for env_var in deployment_setting["variables"] %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">{{ env_var['name'] }}</td>
              <td class="govuk-table__cell">{{ env_var['value'] }} {% if env_var["value"] == None %}<b style="color:red">[Missing]</b>{% endif %} </td>
              <td class="govuk-table__cell">
                {% if request.user.has_perm(env_var["permission_flg"], app) and env_var["editable"] %}
                  {% if "app-var" not in env_var['edit_link'] %}
                    <a class="govuk-button govuk-button--secondary right" href="{{ url(env_var['edit_link'], kwargs={'pk': app.id}) }}?env_name={{ env_name }}" >Edit</a>
                  {% else %}
                    <a class="govuk-button govuk-button--secondary right" href="{{ url(env_var['edit_link'], kwargs={'pk': app.id, 'var_name':env_var['name'] }) }}?env_name={{ env_name }}" >Edit</a>
                  {% endif %}
                {% endif %}
              </td>
              <td class="govuk-table__cell">
                {% if request.user.has_perm(env_var["permission_flg"], app) and env_var["removable"] %}
                  <form action="{{ url(env_var['remove_link'], kwargs={'pk': app.id, 'var_name':env_var['name']}) }} " method="post">
                    {{ csrf_input }}
                    <input type="hidden" name="env_name" value="{{ env_name }}">
                    <button class="govuk-button cpanel-button--destructive js-confirm"
                          data-confirm-message="Are you sure you want to delete this variable?">
                      Delete
                    </button>
                  </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
            <tr class="govuk-table__row">
              <td><a href="{{ url('create-app-var', kwargs={'pk': app.id} ) }}?env_name={{ env_name }}" class="govuk-button" >Add new Variable</a></td>
            </tr>
          </tbody>
        </table>
      </section>

      {% if not deployment_setting["auth_required"] %}
      <div>
        <p style="color:red">As the authentication flag is off, authentication related missing-warnings can be ignored.</p>
      </div>
      {% endif %}
    {% endfor %}
  {% endif %}

</section>

<section class="cpanel-section">
  <h2 class="govuk-heading-m">
    App admins
    {{ modal_dialog(app_admins_html|safe) }}
  </h2>

  <table class="govuk-table app-admins form-group">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th class="govuk-table__header">User</th>
        <th class="govuk-table__header">
          <span class="govuk-visually-hidden">Actions</span>
        </th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
    {% set app_admins = app.admins %}
    {% for user in app_admins %}
      <tr class="govuk-table__row">
        <td class="govuk-table__cell">
        {% if user.auth0_id %}
          <a class="{% if request.user.auth0_id == user.auth0_id %}highlight-current{% endif %}"
              href="{{ url('manage-user', kwargs={ 'pk': user.auth0_id }) }}">
            {{ user_name(user) }}
          </a>
        {% else %}
          {{ user_name(user) }}
        {% endif %}
        </td>
        {% if request.user.has_perm('api.revoke_app_admin', app) %}
        <td class="govuk-table__cell align-right">
          {% if user.id %}
            <form action="{{ url('revoke-app-admin', kwargs={ "pk": app.id, "user_id": user.id }) }}" method="post">
              {{ csrf_input }}
              <button class="js-confirm govuk-button govuk-button--secondary right">
              Revoke admin
              </button>
            </form>
          {% endif %}
        </td>
        {% endif %}
      </tr>
    {% endfor %}
    </tbody>
    <tfoot class="govuk-table__foot">
      <tr class="govuk-table__row">
        <td class="govuk-table__cell" colspan="3">
          {{ app_admins|length }} app admin{% if app_admins|length != 1 %}s{% endif %}
        </td>
      </tr>
    </tfoot>
  </table>

{% if request.user.has_perm('api.add_app_admin', app) %}
  {% if admin_options|length %}
  <form action="{{ url('add-app-admin', kwargs={ 'pk': app.id }) }}" method="post" class="govuk-form-group">
    {{ csrf_input }}

    {% call(user) autocomplete({
      "name": "user_id",
      "label": "Give a user admin rights to this app",
      "placeholder": "Start typing to find a user...",
      "items": admin_options,
    }) %}
      <option value="{{ user.auth0_id }}">{{ user_name(user) }}</option>
    {% endcall %}

    <div class="govuk-form-group">
      <button class="govuk-button">Grant access</button>
    </div>
  </form>
  {% else %}
  <p class="govuk-body">
    (All available users are already admins of this app.)
  </p>
  {% endif %}
{% endif %}
</section>

<section class="cpanel-section">
  <h2 class="govuk-heading-m">App data sources</h2>

  <table class="govuk-table app-data-sources form-group">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th class="govuk-table__header">Name</th>
        <th class="govuk-table__header">
          Access level
          {{ modal_dialog(app_access_levels_html|safe) }}
        </th>
        <th class="govuk-table__header">
          <span class="govuk-visually-hidden">Actions</span>
        </th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
      {% set buckets = app.apps3buckets.all() %}
      {% set num_buckets = buckets|length %}
      {% for bucket in buckets %}
      <tr class="govuk-table__row">
        <td class="govuk-table__cell">
          <a href="{{ url('manage-datasource', kwargs={ "pk": bucket.s3bucket.id }) }}">{{ bucket.s3bucket.name }}</a>
        </td>
        <td class="govuk-table__cell">
          {{ yes_no(bucket.access_level, 'readwrite', "Read/write", "Read only") }}
        </td>
        <td class="govuk-table__cell align-right">
          {% if request.user.has_perm('api.update_apps3bucket', bucket) %}
          <form action="{{ url('update-app-access', kwargs={ "pk": bucket.id }) }}" method="post" class="form-control-prefix">
            {{ csrf_input }}
            <input type="hidden" name="access_level" value="{{ yes_no(bucket.access_level, 'readwrite', 'readonly', 'readwrite') }}">
            <button class="js-confirm govuk-button govuk-button--secondary">
              Set {{ yes_no(bucket.access_level, 'readwrite', 'read only', 'read/write') }}
            </button>
          </form>
          {% if request.user.has_perm('api.remove_app_bucket', app) %}
          <form action="{{ url('revoke-app-access', kwargs={ "pk": bucket.id }) }}" method="post" class="form-control-prefix">
            {{ csrf_input }}
            <button class="js-confirm govuk-button govuk-button--secondary">
              Disconnect
            </button>
          </form>
        {% endif %}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot class="govuk-table__foot">
      <tr class="govuk-table__row">
        <td class="govuk-table__cell" colspan="3">
          {{ num_buckets }} app data source{% if buckets != 1 %}s{% endif %}
        </td>
      </tr>
    </tfoot>
  </table>

{% if request.user.has_perm('api.add_app_bucket', app) %}
  {% set num_bucket_options = grant_access_form.datasource|length - 1 %}
  {% if num_bucket_options %}
    <form action="{{ url('grant-app-access', kwargs={ "pk": app.id }) }}" method="post">
    {{ csrf_input }}
    <input type="hidden" name="access_level" value="readonly">
    <div class="govuk-form-group">
      {{ govukLabel({"text": "Connect an app data source"}) }}
      {% if grant_access_form.datasource.errors -%}
      {{ govukErrorMessage({"text": grant_access_form.datasource.errors|join(". ")}) }}
      {%- endif %}
      {{ grant_access_form.datasource }}
    </div>
    <div class="govuk-form-group">
      <button class="govuk-button govuk-button--secondary">
        Grant access
      </button>
    </div>
  </form>
  {% else %}
  <p class="govuk-body">
    (All available data sources are already connected to this app.)
  </p>
  {% endif %}
{% endif %}
</section>

{% if request.user.has_perm('api.view_app_logs', app) %}
<section class="cpanel-section">
  <h2 class="govuk-heading-m">App logs</h2>
  {{ app_logs(app, kibana_base_url) }}
</section>
{% endif %}

{% if request.user.has_perm('api.destroy_app', app) %}
<section class="cpanel-section">
  <form action="{{ url('delete-app', kwargs={ "pk": app.id }) }}" method="post">
    {{ csrf_input }}
    <button class="govuk-button cpanel-button--destructive js-confirm"
            data-confirm-message="Are you sure you want to delete this app?">
      Delete app
    </button>
  </form>
</section>
{% endif %}

{% endblock %}
