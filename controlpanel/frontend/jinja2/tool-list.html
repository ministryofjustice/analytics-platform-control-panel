{% extends "base.html" %}

{% set page_title = "Your tools" %}
{% set page_name = "tools" %}

{% block content %}

<h1 class="govuk-heading-xl">Your tools</h1>

<p class="govuk-body">The status of your tools will update automatically.</p>


{# Grid Container for the list of tools (1 column, n rows) #}
<div class="tools-list" style="display: grid; grid-template-columns: 1fr; border-top: 1px solid #b1b4b6; margin-bottom: 30px;">
  {% for chart_name, tool_info in tools_info.items() %}
    {% set deployment = tool_info["deployment"] %}

    {# Grid Container for a Tool details (1 column, n rows) #}
    <div class="tool sse-listener" data-tool-name="{{ chart_name }}"  style="display: grid; grid-template-columns: 1fr; border-bottom: 1px solid #b1b4b6;">

      {# 1st row is also a grid with 3 columns #}
      <div style="grid-column: 1/2; display: grid; grid-template-columns: 1fr 1fr 1fr;">

        {# 1st column with Tool name #}
        <h3 class="tool-header" style="grid-column: 1/2; align-self: center;">
          {{ tool_info["name"] }}
        </h3>

        {# 2nd column with Tool status #}
        <div class="tool-status" style="grid-column: 2/3; align-self: center;">
          <span class="tool-status-label">
            {{ deployment and deployment.get_status(id_token) | default("") }}
          </span>
        </div>

        {# 3rd column with Tool actions #}
        <div class="tool-actions" style="grid-column: 3/4; align-self: center;" >

          <a class="govuk-button govuk-button--secondary tool-action {% if not deployment %} govuk-visually-hidden {% endif %}"
              data-action-name="open"
              href="{{ tool_info['url'] }}"
              rel="noopener"
              target="_blank"
              style="margin: 0px"
          >
            Open
          </a>

          <form action="{{ url('restart-tool', kwargs={'name': chart_name}) }}"
                class="background-submit tool-action {% if not deployment %} govuk-visually-hidden {% endif %}"
                data-action-name="restart"
                method="post"
          >
            {{ csrf_input }}
            <button class="govuk-button govuk-button--secondary right" style="margin: 0px">
              Restart
            </button>
          </form>

        </div>

      </div >

      {# 2nd row for version selection #}
      <form action="{{ url('deploy-tool', kwargs={"name": chart_name}) }}"
            class="background-submit tool-action"
            data-action-name="deploy"
            method="post"
            style="grid-column: 1/2; display: grid; grid-template-columns: 1fr 1fr 1fr;"
            >

        <div style="grid-column: 1/3; align-content:center;">
          <span>Version:</span>

          <select name="version" class="govuk-select" style="width: 570px">
            {% set installed_chart_version = None %}

            {# Option for current version (if installed) #}
            {% if deployment %}
              {% set installed_chart_version = deployment.get_installed_chart_version(id_token) %}
              <option class="installed" value="{{ installed_chart_version }}">
                [{{ installed_chart_version }}]  {{ deployment.get_installed_app_version(id_token) or "Unknown" }} (installed)
              </option>
            {% else %}
              <option class="not-installed">(not installed)</option>
            {% endif %}

            {% for chart_version, app_version in tool_info["versions"].items(): %}
              {% if chart_version != installed_chart_version: %}
                <option value="{{ chart_version }}">
                  [{{ chart_version }}]  {{ app_version or "Unknown" }}
                </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div style="grid-column: 3/4; align-content:center;">
          <button class="govuk-button govuk-button--secondary right js-confirm" data-confirm-message="Do you wish to install this version of {{ tool_info['name'] }}?" style="float: left; margin-left: 0px;">
            Deploy
          </button>
          {{ csrf_input }}
        </div>

      </form>

    </div>
  {% endfor %}
</div>


<p class="govuk-body">
  {% if env == "alpha" %}
    You can <a href="https://grafana.services.{{ env }}.mojanalytics.xyz/d/platformusers/platform-users?refresh=10s&orgId=1&var-Username={{ request.user.username }}" target="_blank" rel="noopener">view your resource utilisation on Grafana (opens in new tab)</a>.
  {% else %}
    <em>(Grafana not available in {{ env }} environment)</em>
  {% endif %}
</p>
{% endblock %}
