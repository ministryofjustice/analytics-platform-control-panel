{% from "input/macro.html" import govukInput %}
{% from "autocomplete/macro.html" import autocomplete %}
{% from "error-summary/macro.html" import govukErrorSummary -%}
{% from "user/macro.html" import user_name %}

{% extends "base.html" %}

{% set page_name = "dashboards" %}
{% set page_title = "Add admin - " ~ dashboard.name %}

{% set back_link_url = dashboard.get_absolute_url() ~ "#admins" %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">

    {% if form.errors %}
      {{ govukErrorSummary(titleText="There is a problem", errorList=form.get_error_summary().items()) }}
    {% endif %}

    <span class="govuk-caption-xl">{{ dashboard.name }}</span>
    <h1 class="govuk-heading-xl">Add admins</h1>

    <p class="govuk-body govuk-!-margin-bottom-0">
      You can choose other Control Panel users to manage access.
    </p>

    <p class="govuk-body">
       This does not grant any author permissions in QuickSight.
    </p>

    <form method="post" action="{{ dashboard.get_absolute_add_admins_url() }}">
      {{ csrf_input }}

      {% set users_field = form["users"] %}
      <div class="govuk-form-group{% if users_field.errors %} govuk-form-group--error{% endif %}">
        <fieldset class="govuk-fieldset">
          <div data-module="moj-add-another">
            {% for user_id in form.users.value() or [""] %}
              {% set index_error = form.users.field.index_errors.get(loop.index0) %}
              <div class="moj-add-another__item">
                {% call(user) autocomplete({
                  "name": users_field.name ~ "[" ~ loop.index0 ~ "]",
                  "items": users_field.field.items,
                  "id": "id_" ~ users_field.name ~ "[" ~ loop.index0 ~ "]",
                  "label": {"text": users_field.label, "classes": "govuk-label--s"},
                  "hint": {"text": users_field.help_text},
                  "formGroup": {"classes": "autocomplete--full-width"},
                  "attributes": {
                    "data-name": users_field.name ~ "[%index%]",
                    "data-id": "id_" ~ users_field.name ~ "[%index%]"
                  },
                  "errorMessage": {"text": index_error} if index_error else None,
                  "value": user_id,
                }) %}
                  <option value="{{ user.auth0_id }}">{{ user_name(user) }}</option>
                {% endcall %}
                {% if (form.users.value() or [""])|length > 1 %}
                <button type="button" class="govuk-button govuk-button--secondary moj-add-another__remove-button">Remove</button>
                {% endif %}
              </div>
            {% endfor %}

            <div class="moj-button-action govuk-!-margin-top-4">
              <button type="button" class="govuk-button govuk-button--secondary moj-add-another__add-button govuk-!-margin-bottom-4">
                Add another user
              </button>
            </div>
          </div>

        </fieldset>
      </div>

      <div class="govuk-button-group">
        <button class="govuk-button" type="submit">Add admins</button>
        <a class="govuk-link" href="{{ dashboard.get_absolute_url() }}#admins">Cancel</a>
      </div>
    </form>

  </div>
</div>
{% endblock %}
